# 🧪 测试自动重建功能

## 🔍 问题分析

你的PDF文件在：`SmartTA/src/pdf/`

但是从 `SmartTA-Backend/` 目录启动时，搜索路径可能需要调整。

---

## ✅ 解决方案

### 方案1：运行测试脚本（推荐）

```bash
cd SmartTA-Backend
python test_rebuild.py
```

这个脚本会：
1. 备份现有数据库
2. 删除数据库
3. 触发自动重建
4. 测试是否成功

### 方案2：手动测试

#### 步骤1：删除数据库

```powershell
# PowerShell
Remove-Item -Recurse -Force .\data\faiss_index

# 或使用Python
# python -c "import shutil, os; shutil.rmtree('./data/faiss_index')"
```

#### 步骤2：启动服务

```bash
cd SmartTA-Backend
uvicorn app:app --reload
```

应该会看到：
```
向量数据库不存在，尝试自动重建...
正在搜索PDF文件...
在 E:\College\Project-SmartTA\SmartTA\src\pdf 找到 8 个PDF文件
  - L1.pdf
  - L2.pdf
  ...
开始重建数据库...
  处理: L1.pdf
  处理: L2.pdf
  ...
✅ 数据库重建完成！添加了 156 个文档块
```

---

## 🐛 如果还是不工作

### 检查1：确认PDF文件位置

运行：
```bash
python -c "import os, glob; print([f for f in glob.glob('../SmartTA/src/pdf/*.pdf')])"
```

### 检查2：添加绝对路径到搜索列表

编辑 `rag_engine/model_manager.py`，在 `_find_pdf_files()` 方法中添加：

```python
pdf_dirs = [
    settings.pdf_dir,
    r"E:\College\Project-SmartTA\SmartTA\src\pdf",  # 添加绝对路径
    os.path.join(current_dir, "src", "pdf"),
    # ... 其余路径
]
```

### 检查3：手动指定PDF目录

直接在代码中硬编码PDF路径（用于测试）：

在 `_find_pdf_files()` 中添加：
```python
# 测试用：直接指定PDF目录
test_pdf_dir = os.path.join(os.path.dirname(os.path.dirname(current_dir)), "SmartTA", "src", "pdf")
if os.path.exists(test_pdf_dir):
    pdf_files = glob.glob(os.path.join(test_pdf_dir, "*.pdf"))
    if pdf_files:
        print(f"在测试路径 {test_pdf_dir} 找到 {len(pdf_files)} 个PDF文件")
        return pdf_files
```

---

## 📝 调试信息

查看日志输出，重点关注：

```
正在搜索PDF文件...
在 [路径] 找到 [数量] 个PDF文件
```

如果看到：
```
正在搜索PDF文件...
未找到PDF文件
```

说明搜索路径不正确。

---

## ✅ 快速修复

最简单的解决方案：在 `model_manager.py` 的 `_find_pdf_files()` 中添加绝对路径：

```python
def _find_pdf_files(self):
    """查找可用的PDF文件"""
    current_dir = os.getcwd()
    
    # 添加项目根目录的绝对路径
    project_root = os.path.abspath(os.path.join(current_dir, ".."))
    smartta_pdf_dir = os.path.join(project_root, "SmartTA", "src", "pdf")
    
    pdf_dirs = [
        smartta_pdf_dir,  # 首先尝试项目根目录
        settings.pdf_dir,
        os.path.join(current_dir, "src", "pdf"),
        # ... 其他路径
    ]
    
    # 打印调试信息
    print(f"当前目录: {current_dir}")
    print(f"项目根目录: {project_root}")
    print(f"SmartTA PDF目录: {smartta_pdf_dir}")
    print(f"目录存在: {os.path.exists(smartta_pdf_dir)}")
    
    # ... 其余代码
```

---

## 🎯 验证重建是否工作

运行测试后，检查：

```bash
# 查看数据库是否存在
ls data/faiss_index/

# 查看日志
cat smartta.log | grep -i "重建"
```

如果看到 "✅ 数据库重建完成！"，说明成功了！

