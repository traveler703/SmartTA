# 🔄 向量数据库自动重建功能

## ✨ 新增功能

现在系统支持**自动重建向量数据库**！如果数据库不存在，系统会自动查找PDF文件并重建数据库。

---

## 📋 工作流程

### 场景1：首次启动（无数据库）

1. 系统检测到 `data/faiss_index/` 不存在
2. 自动搜索以下目录中的PDF文件：
   - `./data/pdfs/` （默认）
   - `./src/pdf/`
   - `./pdfs/`
   - `./data/`
3. 如果找到PDF文件，自动处理并创建数据库
4. 如果没找到PDF文件，显示友好的错误提示

### 场景2：数据库已存在

- 正常加载现有数据库
- 响应时间 < 1秒（使用缓存）

### 场景3：手动添加PDF

1. 调用 `/add_pdfs` 接口上传PDF
2. 数据库自动更新
3. 无需重启服务

---

## 🎯 使用示例

### 示例1：首次启动（有PDF文件）

```bash
# 启动服务
cd SmartTA-Backend
uvicorn app:app --reload
```

输出：
```
INFO:     Started server process
INFO:     Waiting for application startup.
加载嵌入模型: sentence-transformers/all-mpnet-base-v2
向量数据库不存在，尝试自动重建...
找到 8 个PDF文件：
  - L1.pdf
  - L2.pdf
  - L3.pdf
  - L4.pdf
  - L5.pdf
  - ... 还有 3 个文件
开始重建数据库...
  处理: L1.pdf
  处理: L2.pdf
  ...
✅ 数据库重建完成！添加了 156 个文档块
加载向量数据库: ./data/faiss_index
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 示例2：首次启动（无PDF文件）

```bash
# 启动服务
cd SmartTA-Backend
uvicorn app:app --reload
```

输出：
```
INFO:     Started server process
INFO:     Waiting for application startup.
加载嵌入模型: sentence-transformers/all-mpnet-base-v2
向量数据库不存在，尝试自动重建...
ERROR: 向量数据库不存在且未找到PDF文件。
请执行以下操作之一：
1. 上传PDF文件到 ./data/pdfs
2. 或调用 /add_pdfs 接口上传PDF
3. 或手动创建数据库
```

**解决方案**：
```bash
# 上传PDF文件
curl -X POST http://localhost:8000/add_pdfs \
  -F "directory=./src/pdf"
```

---

## 🔍 查找PDF文件的目录

系统会按以下顺序搜索PDF文件：

1. `./data/pdfs/` （配置文件中的默认路径）
2. `./src/pdf/` （项目中常见的PDF目录）
3. `./pdfs/` （备用目录）
4. `./data/` （数据目录）

**优先级**：按顺序查找，找到第一个包含PDF的目录即停止。

---

## 🛠️ 手动触发重建

如果需要手动重建数据库（例如更换了模型），可以：

### 方法1：删除数据库目录

```bash
# Windows PowerShell
Remove-Item -Recurse -Force .\data\faiss_index

# Linux/Mac
rm -rf ./data/faiss_index
```

然后重启服务，系统会自动重建。

### 方法2：调用API重新上传PDF

```bash
curl -X POST http://localhost:8000/add_pdfs \
  -F "directory=./src/pdf"
```

---

## ⚙️ 配置

在 `rag_engine/config.py` 中可以配置：

```python
# 默认PDF目录
pdf_dir: str = "./data/pdfs"

# 数据库路径
db_path: str = "./data/faiss_index"

# 数据目录
data_dir: str = "./data"
```

---

## 📊 性能说明

### 数据库重建时间

| 文件数量 | 重建时间 | 文档块数量 |
|---------|---------|-----------|
| 1-5个PDF | 5-15秒 | 50-200个 |
| 10-20个PDF | 30-60秒 | 500-1000个 |
| 50+个PDF | 2-5分钟 | 5000+个 |

### 内存使用

- 数据库重建时：临时增加内存（约+200MB）
- 重建完成后：恢复正常
- 长期使用：稳定在500MB-1GB

---

## ⚠️ 注意事项

### 1. PDF文件格式

- ✅ 支持的格式：PDF（文本版）
- ⚠️ 扫描版PDF（纯图片）需要OCR支持
- ❌ 加密的PDF可能无法处理

### 2. 文件编码

- 确保PDF文件是文本版（非扫描版）
- 中文内容需要正确的编码

### 3. 模型切换

**重要**：切换embedding模型后，必须重建数据库！

```python
# 在 rag_engine/config.py 修改
embedding_model: str = "sentence-transformers/all-mpnet-base-v2"
# 或
embedding_model: str = "intfloat/multilingual-e5-base"
```

切换后：
1. 删除旧的数据库：`rm -rf ./data/faiss_index`
2. 重启服务
3. 系统会自动重建

---

## 🐛 故障排除

### 问题1：找不到PDF文件

**症状**：数据库重建失败，提示"未找到PDF文件"

**解决**：
1. 检查PDF文件是否在搜索目录中
2. 将PDF文件放到 `./data/pdfs/` 或 `./src/pdf/`
3. 重启服务

### 问题2：重建很慢

**症状**：启动时间很长

**解决**：
- 正常现象，首次启动需要时间
- 可以调整 `chunk_size` 和 `chunk_overlap` 参数
- 或使用更小的模型

### 问题3：内存不足

**症状**：重建过程中内存溢出

**解决**：
1. 减少 `chunk_size`
2. 分批处理PDF文件
3. 使用更小的embedding模型

---

## 🎉 总结

自动重建功能让系统更加智能和便捷：

- ✅ **零配置启动** - 直接运行即可
- ✅ **自动发现PDF** - 智能查找PDF文件
- ✅ **友好错误提示** - 清晰的错误信息
- ✅ **无缝集成** - 不影响现有功能
- ✅ **高性能** - 使用缓存的模型

**享受自动化的便利！** 🚀

